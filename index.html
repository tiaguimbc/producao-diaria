<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produção Diária - Gestão de Equipa</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            background-image: linear-gradient(rgba(241,245,249,0.5), rgba(241,245,249,0.92)), url('unnamed.jpg');
            background-size: cover;
            background-attachment: fixed;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active {
            background-color: rgba(248,250,252,0.9);
            border-bottom: 3px solid #2563eb;
            font-weight: 800;
        }
        .card-concluir.success {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="min-h-screen font-sans text-slate-900">

<main class="max-w-7xl mx-auto px-4 py-6">

    <div class="flex gap-2 mb-6">
        <button onclick="switchTab('tiago')" id="btn-tiago" class="tab-button active px-4 py-2 rounded-xl">Tiago</button>
        <button onclick="switchTab('alana')" id="btn-alana" class="tab-button px-4 py-2 rounded-xl">Alana</button>
        <button onclick="switchTab('william')" id="btn-william" class="tab-button px-4 py-2 rounded-xl">William</button>
        <button onclick="switchTab('concluidos')" id="btn-concluidos" class="tab-button px-4 py-2 rounded-xl">Concluídos</button>
    </div>

    <div id="export-area" class="mb-4 hidden">
        <button onclick="exportarConcluidosDoDiaXLSX()"
            class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold text-xs flex items-center gap-2">
            <i data-lucide="file-spreadsheet"></i>
            EXPORTAR XLSX DO DIA
        </button>
    </div>

    <div id="tiago" class="tab-content active"><div id="container-tiago"></div></div>
    <div id="alana" class="tab-content"><div id="container-alana"></div></div>
    <div id="william" class="tab-content"><div id="container-william"></div></div>
    <div id="concluidos" class="tab-content"><div id="container-concluidos"></div></div>

</main>

<script>
const DB_NAME = 'producao_diaria_db';
let currentTab = 'tiago';

let store = JSON.parse(localStorage.getItem(DB_NAME)) || {
    tiago: [], alana: [], william: [], concluidos: []
};

function save() {
    localStorage.setItem(DB_NAME, JSON.stringify(store));
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

    document.getElementById(tab).classList.add('active');
    document.getElementById('btn-' + tab).classList.add('active');

    document.getElementById('export-area').classList.toggle('hidden', tab !== 'concluidos');

    renderCards();
}

function concluirChamado(id) {
    const index = store[currentTab].findIndex(i => i._id === id);
    if (index === -1) return;

    const item = store[currentTab].splice(index, 1)[0];
    item._concluidoEm = new Date().toLocaleString('pt-BR');
    store.concluidos.push(item);
    save();
    renderCards();
}

function renderCards() {
    const container = document.getElementById('container-' + currentTab);
    container.innerHTML = '';

    store[currentTab].forEach(item => {
        const div = document.createElement('div');
        div.className = 'border p-4 rounded-xl mb-3 bg-white';

        div.innerHTML = `
            <div class="font-bold mb-2">${item["Serial Rastreador"] || "Sem Serial"}</div>
            ${currentTab !== 'concluidos' ?
                `<button onclick="concluirChamado('${item._id}')"
                 class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs">
                 Concluir</button>` :
                `<span class="text-emerald-600 font-bold text-xs">Concluído em ${item._concluidoEm}</span>`
            }
        `;
        container.appendChild(div);
    });

    lucide.createIcons();
}

function exportarConcluidosDoDiaXLSX() {
    const hoje = new Date().toLocaleDateString('pt-BR');

    const dados = store.concluidos.filter(i =>
        new Date(i._concluidoEm).toLocaleDateString('pt-BR') === hoje
    );

    if (!dados.length) {
        alert('Nenhum concluído hoje');
        return;
    }

    const planilha = dados.map(i => ({
        "Serial Rastreador": i["Serial Rastreador"] || "",
        "Iccid": i["Iccid"] || "",
        "Branch": i["Branch"] || "",
        "Branch Via Argo": i["Branch Via Argo"] || ""
    }));

    const ws = XLSX.utils.json_to_sheet(planilha);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Concluidos");

    XLSX.writeFile(wb, `concluidos_${hoje.replace(/\//g,'-')}.xlsx`);
}

window.onload = () => renderCards();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produção Diária - Gestão de Equipa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-image: linear-gradient(rgba(248, 250, 252, 0.7), rgba(248, 250, 252, 0.8)), url('unnamed (1).jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background-color: white;
            border-bottom: 3px solid #2563eb; 
            color: #1e40af;
            font-weight: 800;
        }
        .card-animation {
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .card-concluir {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #ffffff;
        }
        .card-concluir.success {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .card-selected {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .solid-panel {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="font-sans text-slate-900 pb-10">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="font-bold text-blue-600 animate-pulse uppercase tracking-widest text-sm">A Enviar para Planilha Google...</p>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                    <i data-lucide="layers" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-800 leading-none uppercase">Produção Diária</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Gestão de Seriais e Logística</p>
                </div>
            </div>

            <div class="flex items-center gap-2 w-full md:w-auto">
                <div class="relative flex-1 md:w-64">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="search-input" oninput="filterCards()" placeholder="Procurar serial ou chamado..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-sm focus:ring-2 focus:ring-blue-500 transition-all outline-none">
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex solid-panel rounded-2xl shadow-sm mb-6 p-1 overflow-x-auto">
            <button onclick="switchTab('tiago')" id="btn-tiago" class="tab-button active flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> Tiago
            </button>
            <button onclick="switchTab('alana')" id="btn-alana" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> Alana
            </button>
            <button onclick="switchTab('william')" id="btn-william" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> William
            </button>
            <button onclick="switchTab('concluidos')" id="btn-concluidos" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all text-emerald-600">
                <i data-lucide="check-circle" class="w-4 h-4"></i> Concluídos
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <aside id="import-panel" class="space-y-4">
                <div class="solid-panel p-5 rounded-3xl shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>
                            <h2 class="font-bold text-slate-700">Importar: <span id="current-name" class="text-blue-600">Tiago</span></h2>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="relative block group">
                            <div class="h-28 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center bg-slate-50 group-hover:bg-blue-50 group-hover:border-blue-200 transition-all cursor-pointer">
                                <i data-lucide="file-up" class="w-8 h-8 text-slate-300 group-hover:text-blue-500"></i>
                                <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase">Carregar CSV</span>
                            </div>
                            <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <textarea id="paste-area" placeholder="Cole aqui as linhas do Excel..." class="w-full h-24 p-4 border border-slate-200 rounded-2xl text-xs focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none bg-slate-50 custom-scroll"></textarea>
                        <button onclick="processPastedData()" class="w-full bg-slate-900 text-white py-3 rounded-2xl font-bold text-xs hover:bg-black transition-all flex items-center justify-center gap-2 shadow-lg">
                            <i data-lucide="database" class="w-4 h-4"></i> ADICIONAR REGISTOS
                        </button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-5 rounded-3xl text-white shadow-lg shadow-blue-200/50">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-sm">Estatísticas</h3>
                        <i data-lucide="activity" class="w-4 h-4 opacity-50"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/10 p-3 rounded-2xl">
                            <p class="text-[10px] opacity-70 uppercase font-bold">Total Aba</p>
                            <p class="text-2xl font-black" id="stat-total">0</p>
                        </div>
                        <div class="bg-white/10 p-3 rounded-2xl">
                            <p class="text-[10px] opacity-70 uppercase font-bold">Total Concluídos</p>
                            <p class="text-2xl font-black" id="stat-done">0</p>
                        </div>
                    </div>
                    <button onclick="clearCurrentTab()" class="w-full mt-4 py-2 border border-white/20 rounded-xl text-[10px] font-black uppercase hover:bg-white/10 transition-colors">Limpar Aba Local</button>
                </div>
            </aside>

            <section id="cards-grid" class="lg:col-span-2">
                <div id="concluidos-tools" class="hidden mb-4 flex justify-between items-center solid-panel p-3 rounded-2xl shadow-sm">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked)" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-xs font-bold text-slate-600 group-hover:text-blue-600 transition-colors uppercase">Selecionar Todos</span>
                        </label>
                    </div>
                    <p class="text-[9px] font-black text-blue-500 uppercase">Banco de Dados Ativo (Planilha Google)</p>
                </div>

                <div id="tiago" class="tab-content active"><div class="space-y-4" id="container-tiago"></div></div>
                <div id="alana" class="tab-content"><div class="space-y-4" id="container-alana"></div></div>
                <div id="william" class="tab-content"><div class="space-y-4" id="container-william"></div></div>
                <div id="concluidos" class="tab-content"><div class="space-y-4" id="container-concluidos"></div></div>

                <div id="empty-state" class="hidden py-20 text-center opacity-30 flex flex-col items-center">
                    <i data-lucide="package-open" class="w-16 h-16 mb-4"></i>
                    <p class="text-sm font-bold uppercase tracking-widest text-slate-600">Nenhum registo pendente</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        // CONFIGURAÇÃO DO GOOGLE APPS SCRIPT FORNECIDA PELO UTILIZADOR
        const WEB_APP_URL = "https://script.google.com/a/macros/queonetics.com/s/AKfycby2ftCCf4SipPtZPnMuzzFFBcLoB54OXp4ssOk7hLS0w8aRK-b9C_CmVaR8lJihVgPg/exec";

        const DB_NAME = 'producao_diaria_v2';
        let currentTab = 'tiago';
        let selectedIds = new Set();
        
        let store = JSON.parse(localStorage.getItem(DB_NAME)) || { 
            tiago: [], alana: [], william: [], concluidos: [] 
        };

        const camposSeriais = [
            "Serial Rastreador", "Iccid", "Serial TX009", "Serial Leitor", 
            "Serial Teclado", "Serial Smart Speaker", "Serial Câmera", "Iccid Camera"
        ];

        function save() {
            localStorage.setItem(DB_NAME, JSON.stringify(store));
            updateStats();
        }

        // Função de envio com Retry Logic (Exponencial Backoff não é suportado nativamente pelo fetch simples sem wrapper,
        // mas implementamos uma versão simplificada de tentativa única para estabilidade no ambiente)
        async function enviarParaPlanilha(item) {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // Prepara os dados removendo campos internos com prefixo _ (exceto os necessários para o script)
            const payload = { ...item };

            try {
                // Google Apps Script exige no-cors para evitar problemas de Redirect ou usar POST via formulário
                // mas para JSON puro via WebApp, no-cors não permite ler a resposta.
                // Como é um Web App do Google, o no-cors enviará os dados, mas não saberemos o status real.
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                showToast("Dados enviados para a Planilha Google!", "success");
            } catch (error) {
                console.error("Erro no envio:", error);
                showToast("Erro ao contactar a Planilha.", "error");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function showToast(msg, type) {
            const feedback = document.createElement('div');
            feedback.className = `fixed bottom-4 right-4 ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'} text-white px-6 py-3 rounded-2xl shadow-2xl font-bold z-50 animate-bounce`;
            feedback.innerText = msg;
            document.body.appendChild(feedback);
            setTimeout(() => feedback.remove(), 3500);
        }

        function switchTab(id) {
            currentTab = id;
            selectedIds.clear();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            document.getElementById('current-name').innerText = id.charAt(0).toUpperCase() + id.slice(1);
            
            const importPanel = document.getElementById('import-panel');
            const cardsGrid = document.getElementById('cards-grid');
            const concluidosTools = document.getElementById('concluidos-tools');

            if(id === 'concluidos') {
                importPanel.classList.add('hidden');
                cardsGrid.classList.replace('lg:col-span-2', 'lg:col-span-3');
                concluidosTools.classList.remove('hidden');
            } else {
                importPanel.classList.remove('hidden');
                cardsGrid.classList.replace('lg:col-span-3', 'lg:col-span-2');
                concluidosTools.classList.add('hidden');
            }
            render();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processData(e.target.result);
                reader.readAsText(file);
                event.target.value = '';
            }
        }

        function processPastedData() {
            const text = document.getElementById('paste-area').value;
            if (text.trim()) { processData(text); document.getElementById('paste-area').value = ''; }
        }

        function processData(rawData) {
            const lines = rawData.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length < 2) return;
            const separator = lines[0].includes('\t') ? '\t' : (lines[0].includes(';') ? ';' : ',');
            const headers = lines[0].split(separator).map(h => h.replace(/"/g, '').trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(separator).map(v => v.replace(/"/g, '').trim());
                let row = { 
                    _id: 'ID-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5), 
                    _origin: currentTab,
                    _createdAt: new Date().toISOString()
                };
                headers.forEach((header, i) => { if(header) row[header] = values[i] || ""; });
                return row;
            });
            store[currentTab] = [...store[currentTab], ...data];
            save(); render();
        }

        function updateFieldValue(id, field, value) {
            const item = store[currentTab].find(i => i._id === id);
            if (item) { item[field] = value; save(); }
        }

        function toggleSelection(id, checked) {
            if (checked) selectedIds.add(id);
            else { selectedIds.delete(id); document.getElementById('select-all').checked = false; }
            const card = document.getElementById(`card-${id}`);
            if (card) { if (checked) card.classList.add('card-selected'); else card.classList.remove('card-selected'); }
        }

        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.card-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const id = cb.getAttribute('data-id');
                if (checked) selectedIds.add(id); else selectedIds.delete(id);
                const card = document.getElementById(`card-${id}`);
                if (card) { if (checked) card.classList.add('card-selected'); else card.classList.remove('card-selected'); }
            });
        }

        function concluirChamado(id, event) {
            const cardElement = event.currentTarget.closest('.card-concluir');
            cardElement.classList.add('success');
            setTimeout(() => {
                const index = store[currentTab].findIndex(i => i._id === id);
                if (index > -1) {
                    const item = store[currentTab].splice(index, 1)[0];
                    item._concluidoEm = new Date().toLocaleString('pt-PT');
                    store.concluidos.unshift(item);
                    save(); render();
                }
            }, 400);
        }

        async function salvarNaPlanilha(id) {
            const item = store.concluidos.find(i => i._id === id);
            if (item) {
                save(); // Salva edições locais primeiro
                await enviarParaPlanilha(item);
            }
        }

        function render() {
            const container = document.getElementById('container-' + currentTab);
            const emptyState = document.getElementById('empty-state');
            const data = store[currentTab];
            container.innerHTML = '';
            if (data.length === 0) { emptyState.classList.remove('hidden'); }
            else {
                emptyState.classList.add('hidden');
                data.forEach(item => {
                    const isConcluido = currentTab === 'concluidos';
                    const card = document.createElement('div');
                    card.id = `card-${item._id}`;
                    card.className = `card-concluir p-5 rounded-3xl border border-slate-200 shadow-sm card-animation ${isConcluido ? 'border-emerald-100 bg-emerald-50' : 'hover:border-blue-300 hover:shadow-md'} ${selectedIds.has(item._id) ? 'card-selected' : ''}`;
                    
                    let inputsHtml = '';
                    camposSeriais.forEach(campo => {
                        inputsHtml += `<div class="bg-slate-50 p-2 px-3 rounded-xl border border-slate-100">
                            <label class="block text-[8px] font-black text-slate-400 uppercase tracking-tighter">${campo}</label>
                            <input type="text" value="${item[campo] || ''}" onchange="updateFieldValue('${item._id}', '${campo}', this.value)" class="w-full bg-transparent text-xs font-bold text-slate-700 outline-none focus:text-blue-600">
                        </div>`;
                    });

                    let infoExtra = '';
                    Object.entries(item).forEach(([k, v]) => {
                        if (!k.startsWith('_') && !camposSeriais.includes(k) && v) {
                            infoExtra += `<div class="flex items-center gap-1 bg-slate-100 px-2 py-1 rounded-md border border-slate-200">
                                <span class="text-[9px] text-slate-400 font-bold uppercase">${k}:</span>
                                <span class="text-[10px] text-slate-800 font-medium">${v}</span>
                            </div>`;
                        }
                    });

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex gap-3 items-center">
                                ${isConcluido ? `<input type="checkbox" data-id="${item._id}" onchange="toggleSelection('${item._id}', this.checked)" ${selectedIds.has(item._id) ? 'checked' : ''} class="card-checkbox w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">` : ''}
                                <div class="flex gap-2 items-center">
                                    <span class="bg-blue-100 text-blue-700 font-black px-3 py-1 rounded-lg text-[9px] uppercase">${item._origin}</span>
                                    <span class="text-[10px] text-slate-500 font-medium">${new Date(item._createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${!isConcluido ? `
                                    <button onclick="concluirChamado('${item._id}', event)" class="bg-emerald-500 text-white px-4 py-2 rounded-xl font-bold text-xs hover:bg-emerald-600 flex items-center gap-2 transition-all shadow-sm active:scale-95">
                                        <i data-lucide="check" class="w-4 h-4"></i> CONCLUIR
                                    </button>` : 
                                    `
                                    <button onclick="salvarNaPlanilha('${item._id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-[10px] hover:bg-blue-700 flex items-center gap-2 transition-all shadow-sm" title="Salvar e Sincronizar">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> SALVAR NA PLANILHA
                                    </button>
                                    <div class="text-right ml-2 leading-tight">
                                        <span class="text-emerald-600 font-black text-[10px] flex items-center justify-end gap-1 uppercase tracking-tighter"><i data-lucide="verified" class="w-3 h-3"></i> Finalizado</span>
                                        <span class="text-[8px] text-slate-400 block font-bold">${item._concluidoEm}</span>
                                    </div>
                                    `}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">${inputsHtml}</div>
                        <div class="flex flex-wrap gap-2 border-t border-slate-100 pt-3">${infoExtra}</div>`;
                    container.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        function filterCards() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const cards = document.querySelectorAll(`#container-${currentTab} > div`);
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                const inputs = Array.from(card.querySelectorAll('input[type="text"]')).map(i => i.value.toLowerCase()).join(' ');
                card.style.display = (text.includes(query) || inputs.includes(query)) ? 'block' : 'none';
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = store[currentTab].length;
            document.getElementById('stat-done').innerText = store.concluidos.length;
        }

        function clearCurrentTab() {
            if(confirm(`Limpar apenas os dados locais da aba ${currentTab}?`)) { store[currentTab] = []; save(); render(); }
        }

        window.onload = () => { render(); updateStats(); };
    </script>
</body>
</html>

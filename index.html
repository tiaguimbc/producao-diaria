<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produção Diária - Gestão de Equipa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-image: linear-gradient(rgba(248, 250, 252, 0.7), rgba(248, 250, 252, 0.8)), url('unnamed.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background-color: white;
            border-bottom: 3px solid #2563eb; 
            color: #1e40af;
            font-weight: 800;
        }
        .card-animation {
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .card-concluir {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #ffffff;
        }
        .card-concluir.success {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .solid-panel {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="font-sans text-slate-900 pb-10">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 border-r-4 border-transparent mb-4"></div>
        <p class="font-black text-blue-800 uppercase tracking-widest text-lg animate-pulse text-center">A ENVIAR PARA A PLANILHA...<br><span class="text-xs text-slate-500 font-normal">Aguarde a confirmação do Google</span></p>
    </div>

    <!-- Elementos ocultos para envio via iframe -->
    <!-- Adicionada verificação no onload para evitar ReferenceError -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(typeof finalizeSubmit === 'function') finalizeSubmit()"></iframe>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                    <i data-lucide="layers" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-800 leading-none uppercase">Produção Diária</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Gestão de Seriais e Logística</p>
                </div>
            </div>

            <div class="flex items-center gap-2 w-full md:w-auto">
                <div class="relative flex-1 md:w-64">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="search-input" oninput="filterCards()" placeholder="Procurar registo..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-sm focus:ring-2 focus:ring-blue-500 transition-all outline-none">
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex solid-panel rounded-2xl shadow-sm mb-6 p-1 overflow-x-auto">
            <button onclick="switchTab('tiago')" id="btn-tiago" class="tab-button active flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> Tiago
            </button>
            <button onclick="switchTab('alana')" id="btn-alana" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> Alana
            </button>
            <button onclick="switchTab('william')" id="btn-william" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> William
            </button>
            <button onclick="switchTab('concluidos')" id="btn-concluidos" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all text-emerald-600">
                <i data-lucide="check-circle" class="w-4 h-4"></i> Concluídos
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <aside id="import-panel" class="space-y-4">
                <div class="solid-panel p-5 rounded-3xl shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>
                            <h2 class="font-bold text-slate-700">Importar: <span id="current-name" class="text-blue-600">Tiago</span></h2>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="relative block group">
                            <div class="h-28 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center bg-slate-50 group-hover:bg-blue-50 group-hover:border-blue-200 transition-all cursor-pointer">
                                <i data-lucide="file-up" class="w-8 h-8 text-slate-300 group-hover:text-blue-500"></i>
                                <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase">Carregar CSV</span>
                            </div>
                            <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <textarea id="paste-area" placeholder="Cole aqui as linhas do Excel..." class="w-full h-24 p-4 border border-slate-200 rounded-2xl text-xs focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none bg-slate-50 custom-scroll"></textarea>
                        <button onclick="processPastedData()" class="w-full bg-slate-900 text-white py-3 rounded-2xl font-bold text-xs hover:bg-black transition-all flex items-center justify-center gap-2 shadow-lg">
                            <i data-lucide="database" class="w-4 h-4"></i> ADICIONAR REGISTOS
                        </button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-slate-800 to-black p-5 rounded-3xl text-white shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-sm uppercase tracking-tighter">Resumo Local</h3>
                        <i data-lucide="bar-chart-3" class="w-4 h-4 opacity-40"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                            <p class="text-[9px] opacity-50 uppercase font-black">Pendentes</p>
                            <p class="text-2xl font-black" id="stat-total">0</p>
                        </div>
                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                            <p class="text-[9px] opacity-50 uppercase font-black">Concluídos</p>
                            <p class="text-2xl font-black text-emerald-400" id="stat-done">0</p>
                        </div>
                    </div>
                    <button onclick="clearCurrentTab()" class="w-full mt-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl text-[10px] font-black uppercase transition-colors">Limpar Registos Locais</button>
                </div>
            </aside>

            <section id="cards-grid" class="lg:col-span-2">
                <div id="concluidos-tools" class="hidden mb-4 flex justify-between items-center solid-panel p-4 rounded-3xl shadow-sm border-l-4 border-l-emerald-500">
                    <p class="text-[11px] font-black text-slate-600 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-emerald-500"></i> 
                        Os itens abaixo estão prontos para serem enviados à Planilha Google.
                    </p>
                </div>

                <div id="tiago" class="tab-content active"><div class="space-y-4" id="container-tiago"></div></div>
                <div id="alana" class="tab-content"><div class="space-y-4" id="container-alana"></div></div>
                <div id="william" class="tab-content"><div class="space-y-4" id="container-william"></div></div>
                <div id="concluidos" class="tab-content"><div class="space-y-4" id="container-concluidos"></div></div>

                <div id="empty-state" class="hidden py-20 text-center opacity-30 flex flex-col items-center">
                    <i data-lucide="inbox" class="w-16 h-16 mb-4"></i>
                    <p class="text-sm font-black uppercase tracking-widest text-slate-600">Sem registos nesta aba</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        // CONFIGURAÇÃO
        const WEB_APP_URL = "https://script.google.com/a/macros/queonetics.com/s/AKfycby2ftCCf4SipPtZPnMuzzFFBcLoB54OXp4ssOk7hLS0w8aRK-b9C_CmVaR8lJihVgPg/exec";
        const DB_NAME = 'producao_v4_store';
        
        let currentTab = 'tiago';
        let isSubmitting = false;
        let store = JSON.parse(localStorage.getItem(DB_NAME)) || { 
            tiago: [], alana: [], william: [], concluidos: [] 
        };

        const camposSeriais = [
            "Serial Rastreador", "Iccid", "Serial TX009", "Serial Leitor", 
            "Serial Teclado", "Serial Smart Speaker", "Serial Câmera", "Iccid Camera"
        ];

        // FUNÇÃO GLOBALIZADA PARA EVITAR REFERENCE ERROR NO IFRAME
        window.finalizeSubmit = function() {
            if (isSubmitting) {
                isSubmitting = false;
                setTimeout(() => {
                    const overlay = document.getElementById('loading-overlay');
                    if(overlay) overlay.style.display = 'none';
                    showToast("DADOS SINCRONIZADOS COM SUCESSO!", "success");
                }, 1000);
            }
        };

        function save() {
            localStorage.setItem(DB_NAME, JSON.stringify(store));
            updateStats();
        }

        function enviarParaGoogle(item) {
            isSubmitting = true;
            document.getElementById('loading-overlay').style.display = 'flex';

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = WEB_APP_URL;
            form.target = 'hidden_iframe';

            Object.entries(item).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            
            setTimeout(() => {
                if(document.body.contains(form)) document.body.removeChild(form);
            }, 1000);
        }

        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 ${type === 'success' ? 'bg-emerald-600 shadow-emerald-200' : 'bg-red-600 shadow-red-200'} text-white px-10 py-5 rounded-3xl shadow-2xl font-black text-xs z-[100] animate-bounce flex items-center gap-3 border-4 border-white/20`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-octagon'}"></i> ${msg}`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 4000);
        }

        function switchTab(id) {
            currentTab = id;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            document.getElementById('current-name').innerText = id.charAt(0).toUpperCase() + id.slice(1);
            
            const importPanel = document.getElementById('import-panel');
            const cardsGrid = document.getElementById('cards-grid');
            const tools = document.getElementById('concluidos-tools');

            if(id === 'concluidos') {
                importPanel.classList.add('hidden');
                cardsGrid.classList.replace('lg:col-span-2', 'lg:col-span-3');
                tools.classList.remove('hidden');
            } else {
                importPanel.classList.remove('hidden');
                cardsGrid.classList.replace('lg:col-span-3', 'lg:col-span-2');
                tools.classList.add('hidden');
            }
            render();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processData(e.target.result);
                reader.readAsText(file);
                event.target.value = '';
            }
        }

        function processPastedData() {
            const text = document.getElementById('paste-area').value;
            if (text.trim()) { processData(text); document.getElementById('paste-area').value = ''; }
        }

        function processData(rawData) {
            const lines = rawData.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length < 2) return;
            const separator = lines[0].includes('\t') ? '\t' : (lines[0].includes(';') ? ';' : ',');
            const headers = lines[0].split(separator).map(h => h.replace(/"/g, '').trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(separator).map(v => v.replace(/"/g, '').trim());
                let row = { 
                    _id: 'ID-' + Math.random().toString(36).substr(2, 9), 
                    _origin: currentTab,
                    _createdAt: new Date().toISOString()
                };
                headers.forEach((header, i) => { if(header) row[header] = values[i] || ""; });
                return row;
            });
            store[currentTab] = [...store[currentTab], ...data];
            save(); render();
        }

        function updateFieldValue(id, field, value) {
            const item = store[currentTab].find(i => i._id === id);
            if (item) { item[field] = value; save(); }
        }

        function concluirChamado(id, event) {
            const btn = event.currentTarget;
            btn.closest('.card-concluir').classList.add('success');
            setTimeout(() => {
                const index = store[currentTab].findIndex(i => i._id === id);
                if (index > -1) {
                    const item = store[currentTab].splice(index, 1)[0];
                    item._concluidoEm = new Date().toLocaleString('pt-PT');
                    store.concluidos.unshift(item);
                    save(); render();
                }
            }, 400);
        }

        function acaoSalvarPlanilha(id) {
            const item = store.concluidos.find(i => i._id === id);
            if (item) {
                const cleanItem = {};
                Object.keys(item).forEach(key => {
                    if (!key.startsWith('_') || key === '_origin' || key === '_concluidoEm') {
                        cleanItem[key] = item[key];
                    }
                });
                enviarParaGoogle(cleanItem);
            }
        }

        function render() {
            const container = document.getElementById('container-' + currentTab);
            const emptyState = document.getElementById('empty-state');
            const data = store[currentTab];
            container.innerHTML = '';
            
            if (data.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                data.forEach(item => {
                    const isConcluido = currentTab === 'concluidos';
                    const card = document.createElement('div');
                    card.className = `card-concluir p-6 rounded-[2.5rem] border border-slate-200 shadow-sm card-animation ${isConcluido ? 'bg-emerald-50/40 border-emerald-100' : 'bg-white hover:border-blue-300'}`;
                    
                    let inputsHtml = '';
                    camposSeriais.forEach(campo => {
                        inputsHtml += `
                        <div class="bg-slate-50 p-2 px-3 rounded-2xl border border-slate-100 focus-within:border-blue-400 focus-within:bg-white transition-all">
                            <label class="block text-[8px] font-black text-slate-400 uppercase tracking-tighter mb-1">${campo}</label>
                            <input type="text" value="${item[campo] || ''}" onchange="updateFieldValue('${item._id}', '${campo}', this.value)" class="w-full bg-transparent text-xs font-bold text-slate-800 outline-none">
                        </div>`;
                    });

                    let infoExtra = '';
                    Object.entries(item).forEach(([k, v]) => {
                        if (!k.startsWith('_') && !camposSeriais.includes(k) && v) {
                            infoExtra += `
                            <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                                <span class="text-[9px] text-slate-400 font-black uppercase">${k}:</span>
                                <span class="text-[10px] text-slate-700 font-bold">${v}</span>
                            </div>`;
                        }
                    });

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex gap-3 items-center">
                                <span class="bg-slate-900 text-white font-black px-4 py-1.5 rounded-full text-[9px] uppercase tracking-widest">${item._origin}</span>
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-slate-400 font-black uppercase leading-none mb-1">Entrada</span>
                                    <span class="text-[11px] text-slate-600 font-bold leading-none">${new Date(item._createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${!isConcluido ? `
                                    <button onclick="concluirChamado('${item._id}', event)" class="bg-emerald-500 text-white px-6 py-3 rounded-2xl font-black text-[10px] hover:bg-emerald-600 flex items-center gap-2 transition-all shadow-lg shadow-emerald-100 active:scale-95 uppercase tracking-widest">
                                        <i data-lucide="check" class="w-4 h-4"></i> CONCLUIR
                                    </button>` : 
                                    `
                                    <button onclick="acaoSalvarPlanilha('${item._id}')" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] hover:bg-blue-700 flex items-center gap-2 transition-all shadow-lg shadow-blue-100 active:scale-95 uppercase tracking-widest">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> SALVAR NA PLANILHA
                                    </button>
                                    `}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">${inputsHtml}</div>
                        <div class="flex flex-wrap gap-2 border-t border-slate-100 pt-4">
                            ${infoExtra}
                            ${isConcluido ? `<div class="ml-auto flex items-center gap-2 text-[10px] text-emerald-600 font-black uppercase"><i data-lucide="calendar-check" class="w-3 h-3"></i> ${item._concluidoEm}</div>` : ''}
                        </div>`;
                    container.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        function filterCards() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const cards = document.querySelectorAll(`#container-${currentTab} > div`);
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                const inputs = Array.from(card.querySelectorAll('input')).map(i => i.value.toLowerCase()).join(' ');
                card.style.display = (text.includes(query) || inputs.includes(query)) ? 'block' : 'none';
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = (store.tiago.length + store.alana.length + store.william.length);
            document.getElementById('stat-done').innerText = store.concluidos.length;
        }

        function clearCurrentTab() {
            if(confirm(`Deseja limpar permanentemente os registos desta aba local?`)) { 
                store[currentTab] = []; 
                save(); 
                render(); 
            }
        }

        window.onload = () => { render(); updateStats(); };
    </script>
</body>
</html>

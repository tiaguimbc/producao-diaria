<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produção Diária - PCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Biblioteca para ler Excel (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            /* Imagem de fundo */
            background-image: linear-gradient(rgba(248, 250, 252, 0.7), rgba(248, 250, 252, 0.8)), url('unnamed.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background-color: white;
            border-bottom: 3px solid #2563eb; 
            color: #1e40af;
            font-weight: 800;
        }
        .card-animation {
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .card-concluir {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-concluir.success {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .solid-panel {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="font-sans text-slate-900 pb-10">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 border-r-4 border-transparent mb-4"></div>
        <p id="loading-text" class="font-black text-blue-800 uppercase tracking-widest text-lg animate-pulse text-center">A ENVIAR PARA A PLANILHA...</p>
        <p id="loading-subtext" class="text-xs text-slate-500 font-normal mt-2">Aguarde a confirmação do Google</p>
    </div>

    <!-- Elementos ocultos para envio via iframe -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(typeof finalizeSubmit === 'function') finalizeSubmit()"></iframe>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                    <i data-lucide="layers" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-800 leading-none uppercase">Produção Diária - PCP </h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Registro de Chamados Diários</p>
                </div>
            </div>

            <div class="flex items-center gap-2 w-full md:w-auto">
                <div class="relative flex-1 md:w-64">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="search-input" oninput="filterCards()" placeholder="Procurar registo..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-sm focus:ring-2 focus:ring-blue-500 transition-all outline-none">
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex solid-panel rounded-2xl shadow-sm mb-6 p-1 overflow-x-auto">
            <button onclick="switchTab('tiago')" id="btn-tiago" class="tab-button active flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> Tiago
            </button>
            <button onclick="switchTab('alana')" id="btn-alana" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> Alana
            </button>
            <button onclick="switchTab('william')" id="btn-william" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all">
                <i data-lucide="user" class="w-4 h-4"></i> William
            </button>
            <button onclick="switchTab('concluidos')" id="btn-concluidos" class="tab-button flex-1 px-4 py-3 text-sm flex items-center justify-center gap-2 rounded-xl transition-all text-emerald-600">
                <i data-lucide="check-circle" class="w-4 h-4"></i> Concluídos
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <aside id="import-panel" class="space-y-4">
                <div class="solid-panel p-5 rounded-3xl shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>
                            <h2 class="font-bold text-slate-700">Importar: <span id="current-name" class="text-blue-600">Tiago</span></h2>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="relative block group">
                            <div class="h-28 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center bg-slate-50 group-hover:bg-blue-50 group-hover:border-blue-200 transition-all cursor-pointer">
                                <i data-lucide="file-spreadsheet" class="w-8 h-8 text-slate-300 group-hover:text-blue-500"></i>
                                <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase">Carregar Excel ou CSV</span>
                            </div>
                            <!-- Aceita CSV, XLSX e XLS -->
                            <input type="file" id="file-input" accept=".csv, .xlsx, .xls" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <textarea id="paste-area" placeholder="Cole aqui as linhas do Excel..." class="w-full h-24 p-4 border border-slate-200 rounded-2xl text-xs focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none bg-slate-50 custom-scroll"></textarea>
                        <button onclick="processPastedData()" class="w-full bg-slate-900 text-white py-3 rounded-2xl font-bold text-xs hover:bg-black transition-all flex items-center justify-center gap-2 shadow-lg">
                            <i data-lucide="database" class="w-4 h-4"></i> ADICIONAR REGISTOS
                        </button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-slate-800 to-black p-5 rounded-3xl text-white shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-sm uppercase tracking-tighter">Resumo Local</h3>
                        <i data-lucide="bar-chart-3" class="w-4 h-4 opacity-40"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                            <p class="text-[9px] opacity-50 uppercase font-black">Pendentes</p>
                            <p class="text-2xl font-black" id="stat-total">0</p>
                        </div>
                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                            <p class="text-[9px] opacity-50 uppercase font-black">Concluídos</p>
                            <p class="text-2xl font-black text-emerald-400" id="stat-done">0</p>
                        </div>
                    </div>
                    <button onclick="clearCurrentTab()" class="w-full mt-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl text-[10px] font-black uppercase transition-colors">Limpar Registos Locais</button>
                </div>
            </aside>

            <section id="cards-grid" class="lg:col-span-2">
                
                <!-- Barra de Ferramentas da aba Concluídos (Nova) -->
                <div id="concluidos-tools" class="hidden mb-4 solid-panel p-4 rounded-3xl shadow-sm border-l-4 border-l-emerald-500 bg-white">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <p class="text-[11px] font-black text-slate-600 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="info" class="w-4 h-4 text-emerald-500"></i> 
                            Itens prontos para envio
                        </p>
                        <button onclick="acaoSalvarTodos()" class="w-full md:w-auto bg-violet-600 text-white px-6 py-2.5 rounded-xl font-black text-[10px] hover:bg-violet-700 flex items-center justify-center gap-2 transition-all shadow-lg shadow-violet-100 active:scale-95 uppercase tracking-widest">
                            <i data-lucide="rocket" class="w-4 h-4"></i> ENVIAR TUDO PARA O GOOGLE
                        </button>
                    </div>
                </div>

                <div id="tiago" class="tab-content active"><div class="space-y-4" id="container-tiago"></div></div>
                <div id="alana" class="tab-content"><div class="space-y-4" id="container-alana"></div></div>
                <div id="william" class="tab-content"><div class="space-y-4" id="container-william"></div></div>
                <div id="concluidos" class="tab-content"><div class="space-y-4" id="container-concluidos"></div></div>

                <div id="empty-state" class="hidden py-20 text-center opacity-30 flex flex-col items-center">
                    <i data-lucide="inbox" class="w-16 h-16 mb-4"></i>
                    <p class="text-sm font-black uppercase tracking-widest text-slate-600">Sem registos nesta aba</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        // CONFIGURAÇÃO
        const WEB_APP_URL = "https://script.google.com/a/macros/queonetics.com/s/AKfycby2ftCCf4SipPtZPnMuzzFFBcLoB54OXp4ssOk7hLS0w8aRK-b9C_CmVaR8lJihVgPg/exec";
        const DB_NAME = 'producao_v4_store';
        
        let currentTab = 'tiago';
        let isSubmitting = false;
        
        // Variáveis para controle de fila de envio
        let submissionQueue = []; 
        let currentProcessingId = null;

        let store = JSON.parse(localStorage.getItem(DB_NAME)) || { 
            tiago: [], alana: [], william: [], concluidos: [] 
        };

        const camposSeriais = [
            "Serial Rastreador", "Iccid", "Serial TX009", "Serial Leitor", 
            "Serial Teclado", "Serial Smart Speaker", "Serial Câmera", "Iccid Camera"
        ];

        // ==========================================
        // LÓGICA DE ENVIO (FILA E CALLBACK)
        // ==========================================

        window.finalizeSubmit = function() {
            if (!isSubmitting) return;

            // 1. Remove o item que acabou de ser enviado
            if (currentProcessingId) {
                const index = store.concluidos.findIndex(i => i._id === currentProcessingId);
                if (index > -1) {
                    store.concluidos.splice(index, 1);
                    save();
                    render();
                }
                currentProcessingId = null;
            }

            // 2. Verifica se há mais itens na fila
            if (submissionQueue.length > 0) {
                const remaining = submissionQueue.length;
                document.getElementById('loading-text').innerText = `ENVIANDO... RESTAM ${remaining}`;
                // Pequeno delay para não sobrecarregar
                setTimeout(() => {
                    processNextInQueue();
                }, 500);
            } else {
                // 3. Tudo finalizado
                isSubmitting = false;
                setTimeout(() => {
                    const overlay = document.getElementById('loading-overlay');
                    if(overlay) overlay.style.display = 'none';
                    showToast("DADOS SINCRONIZADOS E REMOVIDOS!", "success");
                    
                    // Reseta texto do overlay
                    document.getElementById('loading-text').innerText = "A ENVIAR PARA A PLANILHA...";
                }, 800);
            }
        };

        function processNextInQueue() {
            if (submissionQueue.length === 0) return;
            
            // Pega o próximo da fila
            const item = submissionQueue.shift();
            currentProcessingId = item._id;

            // Prepara dados limpos
            const cleanItem = prepareItemForSend(item);
            enviarParaGoogle(cleanItem);
        }

        function prepareItemForSend(item) {
            const cleanItem = {};
            Object.keys(item).forEach(key => {
                if ((!key.startsWith('_') || key === '_origin' || key === '_concluidoEm') && key !== '_linkChamado') {
                    cleanItem[key] = item[key];
                }
            });
            return cleanItem;
        }

        function enviarParaGoogle(item) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = WEB_APP_URL;
            form.target = 'hidden_iframe';

            Object.entries(item).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            
            setTimeout(() => {
                if(document.body.contains(form)) document.body.removeChild(form);
            }, 1000);
        }

        function acaoSalvarPlanilha(id) {
            const item = store.concluidos.find(i => i._id === id);
            if (!item) return;

            isSubmitting = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "ENVIANDO REGISTO...";
            
            // Adiciona apenas este item à fila
            submissionQueue = [item];
            processNextInQueue();
        }

        function acaoSalvarTodos() {
            if (store.concluidos.length === 0) {
                showToast("Não há itens para enviar!", "error");
                return;
            }

            if(!confirm(`Confirma o envio de ${store.concluidos.length} registos para a planilha?`)) return;

            isSubmitting = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = `PREPARANDO ${store.concluidos.length} ITENS...`;

            // Cria uma cópia da lista para a fila
            submissionQueue = [...store.concluidos];
            processNextInQueue();
        }

        // ==========================================
        // FIM DA LÓGICA DE ENVIO
        // ==========================================

        function save() {
            localStorage.setItem(DB_NAME, JSON.stringify(store));
            updateStats();
        }

        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 ${type === 'success' ? 'bg-emerald-600 shadow-emerald-200' : 'bg-red-600 shadow-red-200'} text-white px-10 py-5 rounded-3xl shadow-2xl font-black text-xs z-[100] animate-bounce flex items-center gap-3 border-4 border-white/20`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-octagon'}"></i> ${msg}`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 4000);
        }

        function switchTab(id) {
            currentTab = id;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            document.getElementById('current-name').innerText = id.charAt(0).toUpperCase() + id.slice(1);
            
            const importPanel = document.getElementById('import-panel');
            const cardsGrid = document.getElementById('cards-grid');
            const tools = document.getElementById('concluidos-tools');

            if(id === 'concluidos') {
                importPanel.classList.add('hidden');
                cardsGrid.classList.replace('lg:col-span-2', 'lg:col-span-3');
                tools.classList.remove('hidden');
            } else {
                importPanel.classList.remove('hidden');
                cardsGrid.classList.replace('lg:col-span-3', 'lg:col-span-2');
                tools.classList.add('hidden');
            }
            render();
        }

        // ==========================================
        // LÓGICA DE IMPORTAÇÃO (CSV E EXCEL)
        // ==========================================

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: false, defval: ""});

                    jsonData.forEach((row, index) => {
                        const cellAddress = XLSX.utils.encode_cell({r: index + 1, c: 0}); 
                        const cell = worksheet[cellAddress];
                        if (cell && cell.l && cell.l.Target) {
                            row._linkChamado = cell.l.Target;
                        }
                    });
                    
                    finalizeImport(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } 
            else if (fileName.endsWith('.csv')) {
                const reader = new FileReader();
                reader.onload = (e) => processCSVData(e.target.result);
                reader.readAsText(file);
            }
            event.target.value = ''; 
        }

        function processPastedData() {
            const text = document.getElementById('paste-area').value;
            if (text.trim()) { 
                processCSVData(text); 
                document.getElementById('paste-area').value = ''; 
            }
        }

        function processCSVData(rawData) {
            const lines = rawData.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length < 2) return;
            const separator = lines[0].includes('\t') ? '\t' : (lines[0].includes(';') ? ';' : ',');
            const headers = lines[0].split(separator).map(h => h.replace(/"/g, '').trim());
            
            const data = lines.slice(1).map(line => {
                const values = line.split(separator).map(v => v.replace(/"/g, '').trim());
                let row = {};
                headers.forEach((header, i) => { if(header) row[header] = values[i] || ""; });
                return row;
            });

            finalizeImport(data);
        }

        function finalizeImport(dataArray) {
            if (!dataArray || dataArray.length === 0) {
                showToast("Nenhum dado encontrado para importar.", "error");
                return;
            }

            const processedData = dataArray.map(item => {
                return {
                    ...item, 
                    _id: 'ID-' + Math.random().toString(36).substr(2, 9), 
                    _origin: currentTab,
                    _createdAt: new Date().toISOString()
                };
            });

            store[currentTab] = [...store[currentTab], ...processedData];
            save(); 
            render();
            showToast(`${processedData.length} registos importados com sucesso!`, "success");
        }

        function updateFieldValue(id, field, value) {
            const item = store[currentTab].find(i => i._id === id);
            if (item) { item[field] = value; save(); }
        }

        function concluirChamado(id, event) {
            const btn = event.currentTarget;
            btn.closest('.card-concluir').classList.add('success');
            setTimeout(() => {
                const index = store[currentTab].findIndex(i => i._id === id);
                if (index > -1) {
                    const item = store[currentTab].splice(index, 1)[0];
                    item._concluidoEm = new Date().toLocaleString('pt-PT');
                    store.concluidos.unshift(item);
                    save(); render();
                }
            }, 400);
        }

        function render() {
            const container = document.getElementById('container-' + currentTab);
            const emptyState = document.getElementById('empty-state');
            const data = store[currentTab];
            container.innerHTML = '';
            
            if (data.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                data.forEach(item => {
                    const isConcluido = currentTab === 'concluidos';
                    const card = document.createElement('div');
                    
                    // Style: White card, rounded, shadow
                    card.className = `card-concluir relative bg-white border border-slate-200 rounded-3xl shadow-sm hover:shadow-md transition-all duration-300 card-animation overflow-hidden group ${isConcluido ? 'border-emerald-100 bg-emerald-50/30' : ''}`;
                    
                    // --- SEPARAÇÃO DE DADOS ---
                    
                    // 1. Identificar Titulo Principal (Geralmente 'Chamados' ou o primeiro campo não-serial)
                    let mainTitle = "Sem Título";
                    let mainLink = null;
                    
                    // Verifica se existe "Chamados" ou "Chamado"
                    if (item['Chamados']) {
                        mainTitle = item['Chamados'];
                        mainLink = item._linkChamado;
                    } else if (item['Chamado']) {
                        mainTitle = item['Chamado'];
                        mainLink = item._linkChamado;
                    } else {
                        // Fallback: Tenta pegar o primeiro campo que não é serial nem interno
                        const firstKey = Object.keys(item).find(k => !k.startsWith('_') && !camposSeriais.includes(k));
                        if(firstKey) mainTitle = item[firstKey];
                    }

                    // 2. Preparar HTML dos Inputs (Seriais)
                    let inputsHtml = '';
                    camposSeriais.forEach(campo => {
                        const hasValue = item[campo] && item[campo].toString().trim() !== '';
                        inputsHtml += `
                        <div class="relative group/input">
                            <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1 pl-1">${campo}</label>
                            <div class="relative flex items-center">
                                <input type="text" 
                                    value="${item[campo] || ''}" 
                                    onchange="updateFieldValue('${item._id}', '${campo}', this.value)" 
                                    class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded-xl px-3 py-2.5 outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all ${hasValue ? 'bg-blue-50/30 border-blue-100 text-blue-800' : ''}"
                                    placeholder="...">
                                ${hasValue ? '<i data-lucide="check" class="absolute right-3 w-3 h-3 text-blue-500 pointer-events-none"></i>' : ''}
                            </div>
                        </div>`;
                    });

                    // 3. Preparar HTML dos Detalhes (Info importada)
                    let detailsHtml = '';
                    Object.entries(item).forEach(([k, v]) => {
                        if (!k.startsWith('_') && !camposSeriais.includes(k) && k !== 'Chamados' && k !== 'Chamado' && v) {
                            detailsHtml += `
                            <div class="flex flex-col border-l-2 border-slate-200 pl-3 py-0.5 hover:border-blue-400 transition-colors">
                                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">${k}</span>
                                <span class="text-[11px] text-slate-700 font-semibold break-words leading-tight">${v}</span>
                            </div>`;
                        }
                    });

                    // --- MONTAGEM DO CARD ---
                    
                    card.innerHTML = `
                        <!-- CABEÇALHO DO CARD -->
                        <div class="px-6 py-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4 bg-slate-50/50">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center shadow-inner flex-shrink-0">
                                    <i data-lucide="${isConcluido ? 'check-circle-2' : 'clipboard-list'}" class="w-5 h-5"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight flex items-center gap-2 truncate">
                                        ${mainTitle}
                                        ${mainLink ? `<a href="${mainLink}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-1 rounded-md transition-colors" title="Abrir link"><i data-lucide="external-link" class="w-3 h-3"></i></a>` : ''}
                                    </h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[9px] font-bold px-2 py-0.5 rounded bg-slate-200 text-slate-600 uppercase tracking-widest">${item._origin}</span>
                                        <span class="text-[9px] font-medium text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${new Date(item._createdAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 flex-shrink-0">
                                ${!isConcluido ? `
                                    <button onclick="concluirChamado('${item._id}', event)" class="w-full md:w-auto bg-slate-900 hover:bg-emerald-600 text-white pl-4 pr-5 py-2.5 rounded-xl font-bold text-[10px] flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-emerald-200 active:scale-95 uppercase tracking-widest group/btn">
                                        <span class="group-hover/btn:hidden flex items-center gap-2">Concluir <i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                                        <span class="hidden group-hover/btn:flex items-center gap-2">Confirmar <i data-lucide="check" class="w-4 h-4"></i></span>
                                    </button>` 
                                : `
                                    <div class="text-right mr-2">
                                        <div class="text-[9px] text-emerald-600 font-black uppercase tracking-widest mb-0.5">Concluído</div>
                                        <div class="text-[9px] text-slate-400 font-medium">${item._concluidoEm || ''}</div>
                                    </div>
                                    <button onclick="acaoSalvarPlanilha('${item._id}')" class="bg-blue-600 text-white p-2.5 rounded-xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-100 active:scale-95" title="Enviar Individualmente">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                                    </button>
                                `}
                            </div>
                        </div>

                        <!-- CORPO DO CARD -->
                        <div class="p-6">
                            <!-- Se houver detalhes importados (Cliente, Placa etc), mostra aqui -->
                            ${detailsHtml ? `
                                <div class="mb-6 bg-slate-50 border border-slate-200 rounded-2xl p-4">
                                    <h4 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> Info do Chamado
                                    </h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-y-4 gap-x-6">
                                        ${detailsHtml}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Área de Inputs (Seriais) -->
                            <div>
                                <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-3 flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Validação de Equipamentos
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                    ${inputsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        function filterCards() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const cards = document.querySelectorAll(`#container-${currentTab} > div`);
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                const inputs = Array.from(card.querySelectorAll('input')).map(i => i.value.toLowerCase()).join(' ');
                card.style.display = (text.includes(query) || inputs.includes(query)) ? 'block' : 'none';
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = (store.tiago.length + store.alana.length + store.william.length);
            document.getElementById('stat-done').innerText = store.concluidos.length;
        }

        function clearCurrentTab() {
            if(confirm(`Deseja limpar permanentemente os registos desta aba local?`)) { 
                store[currentTab] = []; 
                save(); 
                render(); 
            }
        }

        window.onload = () => { render(); updateStats(); };
    </script>
</body>
</html>
